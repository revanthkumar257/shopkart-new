<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Thank You | ShopKart</title>
  <link rel="stylesheet" href="./public/styles.css" />
  <script>window.adobeDataLayer = window.adobeDataLayer || [];</script>
  <script src="./public/products.js"></script>
  <script src="./public/static-data.js"></script>
  <script src="./public/data-layer-helper.js"></script>
  <script>
    (function() {
      const urlParams = new URLSearchParams(window.location.search);
      const orderId = urlParams.get('orderId');
      const order = orderId ? window.StaticData.getOrder(orderId) : null;
      
      if (!order) {
        window.location.href = './index.html';
        return;
      }
      
      // Prevent duplicate purchase events on reload
      if (!order.purchaseEventPushed) {
        const initialPush = window.DataLayerHelper.buildBasePush({
          event: 'purchase',
          pageType: 'thankyou',
          pageName: 'Order Confirmation',
          url: window.location.href,
          extra: { order }
        });
        window.adobeDataLayer.push(initialPush);
        order.purchaseEventPushed = true;
        window.StaticData.setOrder(orderId, order);
      } else {
        const initialPush = window.DataLayerHelper.buildBasePush({
          event: 'pageView',
          pageType: 'thankyou',
          pageName: 'Order Confirmation',
          url: window.location.href
        });
        window.adobeDataLayer.push(initialPush);
      }
      
      window.currentOrder = order;
    })();
  </script>
  <script src="https://assets.adobedtm.com/21b53c73144b/e91b4a5d371e/launch-889ca7a6e623-development.min.js" async></script>
</head>
<body data-page-type="thankyou">
  <header>
    <div class="topbar">
      <div class="logo"><a href="./index.html" style="color:#fff;text-decoration:none;">ShopKart</a></div>
      <form class="search" method="GET" action="./plp.html">
        <input type="text" name="q" placeholder="Search for electronics, fashion, home and more" aria-label="Search products" value="" />
        <button type="submit">Search</button>
      </form>
      <div class="actions">
        <span id="user-info"></span>
        <a href="./account.html" aria-label="Account" id="account-link">Account</a>
        <a href="./logout.html" aria-label="Logout" id="logout-link" style="display:none;">Logout</a>
        <a href="./cart.html" data-role="cart-link" aria-label="Cart">Cart <span class="cart-badge" data-role="cart-count">0</span></a>
      </div>
    </div>
    <div class="categories">
      <a href="./plp.html?cat=electronics">Electronics</a>
      <a href="./plp.html?cat=mobiles">Mobiles</a>
      <a href="./plp.html?cat=fashion">Fashion</a>
      <a href="./plp.html?cat=home">Home</a>
      <a href="./plp.html?cat=beauty">Beauty</a>
      <a href="./plp.html?cat=all">All</a>
    </div>
  </header>
  <main>
  <div id="thankyou-content">
    <p>Loading order details...</p>
  </div>
  </main>
  <footer>
    <p>ShopKart marketplace</p>
  </footer>
  <script src="./public/adl-utils.js"></script>
  <script src="./public/client.js"></script>
  <script>
    (function() {
      if (typeof window.currentOrder === 'undefined') {
        document.getElementById('thankyou-content').innerHTML = '<p>No order found. Please complete checkout.</p>';
        return;
      }
      
      const order = window.currentOrder;
      let html = `
        <h2>Thank you for your order!</h2>
        <p>Your order has been placed successfully. We'll send you a confirmation email shortly.</p>
        <p><a href="./index.html">Return to home</a> or <a href="./plp.html">continue shopping</a></p>
        <div class="summary">
          <h3>Order Summary</h3>
          <p><strong>Order ID:</strong> ${order.id}</p>
          <p><strong>Customer:</strong> ${order.customerName}</p>
          <p><strong>Email:</strong> ${order.email}</p>
          <p><strong>Total:</strong> $${order.revenue.toFixed(2)}</p>
          
          <h4 style="margin-top:20px;">Items Ordered</h4>
          <ul>
      `;
      
      order.products.forEach((p) => {
        html += `<li>${p.productName} — Qty ${p.qty} — $${(p.price * p.qty).toFixed(2)}</li>`;
      });
      
      html += '</ul>';
      
      if (order.shippingAddress) {
        html += `
          <h4 style="margin-top:20px;">Shipping Address</h4>
          <p>
            ${order.shippingAddress.addressLine1}<br/>
            ${order.shippingAddress.addressLine2 ? order.shippingAddress.addressLine2 + '<br/>' : ''}
            ${order.shippingAddress.city}, ${order.shippingAddress.state} ${order.shippingAddress.postalCode}<br/>
            Phone: ${order.shippingAddress.phone}
          </p>
        `;
      }
      
      if (order.paymentMethod) {
        html += `
          <h4 style="margin-top:20px;">Payment Method</h4>
          <p>${order.paymentMethod}</p>
        `;
      }
      
      html += '</div>';
      html += '<a class="button primary" href="./plp.html" style="margin-top:16px;">Continue shopping</a>';
      
      document.getElementById('thankyou-content').innerHTML = html;
      
      // Update user info
      const user = window.StaticData ? window.StaticData.getUser() : null;
      const userInfo = document.getElementById('user-info');
      const accountLink = document.getElementById('account-link');
      const logoutLink = document.getElementById('logout-link');
      
      if (user) {
        if (userInfo) userInfo.textContent = user.name;
        if (accountLink) accountLink.style.display = 'none';
        if (logoutLink) logoutLink.style.display = 'inline';
      } else {
        if (userInfo) userInfo.textContent = '';
        if (accountLink) accountLink.style.display = 'inline';
        if (logoutLink) logoutLink.style.display = 'none';
      }
    })();
  </script>
</body>
</html>
