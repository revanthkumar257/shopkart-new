<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cart | ShopKart</title>
  <link rel="stylesheet" href="./public/styles.css" />
  <script src="./public/adl-init.js"></script>
  <script src="./public/products.js"></script>
  <script src="./public/static-data.js"></script>
  <script src="./public/adl-utils.js"></script>
  <script>
    (function () {
      const user = window.StaticData ? window.StaticData.getUser() : null;
      const url = window.location;

      // 1. Page Load (Metadata Only)
      window.adobeDataLayer.push({
        event: "pageLoaded",
        xdmPageLoad: {
          custData: {
            loginStatus: user ? "logged-in" : "guest",
            platform: "desktop web",
            language: "en"
          },
          _digiwebanoptznapcptrsd: {},
          web: {
            webPageDetails: {
              siteName: "shopkart",
              pageName: "Cart",
              pageType: "cart",
              channel: "web|cart"
            }
          },
          pageUrl: {
            dataLayerUrl: url.href,
            deUrl: url.href,
            urlWithQSP: url.href,
            urlWithoutQSP: url.origin + url.pathname
          }
        }
      });
      console.log("ACDL: pageLoaded tracked (Cart) - Metadata Only");



      // 2. Shopping Cart View (scView) - Enhanced
      const cart = window.StaticData ? window.StaticData.getCart() : { items: [] };
      const items = cart.items || [];
      const coupon = window.StaticData ? window.StaticData.getCoupon() : null;

      // Calculate strict totals for Data Layer
      let grossSubtotal = 0;
      let totalProductDiscount = 0;
      const totalValue = window.StaticData ? window.StaticData.getCartTotal() : 0;

      // Prepare products with full details
      const productsArray = items.map(item => {
        const product = (typeof PRODUCTS !== 'undefined') ? PRODUCTS.find(p => p.id === item.productId) : null;

        const price = Number(item.price);
        // MRP is either from product definition or fallback to price (no discount)
        const mrp = Number(product ? (product.mrp || item.price) : item.price);
        const qty = Number(item.qty);

        const pDiscount = (mrp > price) ? (mrp - price) * qty : 0;

        grossSubtotal += mrp * qty;
        totalProductDiscount += pDiscount;

        return {
          sku: product ? product.sku : (item.sku || ''),
          productID: item.productId,
          productName: item.productName,
          category: product ? product.category : '',
          price: price, // Unit Selling Price
          originalPrice: mrp, // Unit MRP
          quantity: qty,
          color: item.color || '',
          size: item.size || '',
          productImageUrl: item.image, // For consistency
          // ADL Helper will calculate unit-level discount breakdown if we pass ID, 
          // but we can pass explicit values if we want. 
          // ensureProductFields in adl-utils will re-calculate unit discount based on price/mrp.
        };
      });

      // Calculate Coupon Discount
      // Total Value = GrossSubtotal - TotalProductDiscount - CouponDiscount
      // So CouponDiscount = GrossSubtotal - TotalProductDiscount - TotalValue
      // OR more simply: CouponDiscount = (SellingPriceSubtotal - TotalValue) where SellingPriceSubtotal = GrossSubtotal - TotalProductDiscount

      const sellingPriceSubtotal = grossSubtotal - totalProductDiscount;
      const couponDiscountAmount = Math.max(0, sellingPriceSubtotal - totalValue);
      const totalDiscount = totalProductDiscount + couponDiscountAmount;

      if (window.adl && window.adl.trackShoppingCartView) {
        window.adl.trackShoppingCartView({
          products: productsArray,
          subtotal: grossSubtotal, // Gross MRP Total
          productDiscountAmount: totalProductDiscount,
          couponDiscountAmount: couponDiscountAmount,
          totalDiscount: totalDiscount,
          totalValue: totalValue,
          couponCode: coupon ? coupon.code : null,
          totalQuantity: items.reduce((sum, item) => sum + item.qty, 0)
        });
      } else {
        console.warn("ADL Utils not loaded, skipping scView");
      }

    })();
  </script>
  <script src="https://assets.adobedtm.com/21b53c73144b/0bfb0f66930e/launch-c5c9b732c095-development.min.js"
    async></script>
</head>

<body data-page-type="cart">
  <header>
    <div class="topbar">
      <div class="logo"><a href="./index.html" style="color:#fff;text-decoration:none;">ShopKart</a></div>
      <form class="search" method="GET" action="./plp.html">
        <input type="text" name="q" placeholder="Search for electronics, fashion, home and more"
          aria-label="Search products" value="" />
        <button type="submit">Search</button>
      </form>
      <div class="actions">
        <span id="user-info"></span>
        <a href="./account.html" aria-label="Account" id="account-link">Account</a>
        <a href="./logout.html" aria-label="Logout" id="logout-link" style="display:none;">Logout</a>
        <a href="./cart.html" data-role="cart-link" aria-label="Cart">Cart <span class="cart-badge"
            data-role="cart-count">0</span></a>
      </div>
    </div>
    <div class="categories">
      <a href="./plp.html?cat=electronics">Electronics</a>
      <a href="./plp.html?cat=mobiles">Mobiles</a>
      <a href="./plp.html?cat=fashion">Fashion</a>
      <a href="./plp.html?cat=home%20appliances">Home Appliances</a>
      <a href="./plp.html?cat=beauty">Beauty</a>
      <a href="./plp.html?cat=all">All</a>
    </div>
  </header>
  <main>
    <h2>Your Cart</h2>
    <div id="cart-content">
      <p>Loading cart...</p>
    </div>
  </main>
  <footer>
    <p>ShopKart marketplace</p>
  </footer>
  <script src="./public/adl-utils.js"></script>
  <script src="./public/client.js"></script>
  <script>
    (function () {
      function renderCart() {
        const cart = window.StaticData.getCart();
        const subtotal = window.StaticData.getCartSubtotal();
        const total = window.StaticData.getCartTotal();
        const coupon = window.StaticData.getCoupon();

        const container = document.getElementById('cart-content');

        if (!cart.items || cart.items.length === 0) {
          container.innerHTML = '<p>Your cart is empty. Browse the <a href="./plp.html">catalog</a>.</p>';
          return;
        }

        let html = '<table><thead><tr><th></th><th>Product</th><th>Price</th><th>Qty</th><th>Subtotal</th><th></th></tr></thead><tbody>';
        cart.items.forEach((item) => {
          html += `
            <tr>
              <td style="width:80px;">
                ${item.image ? `<img src="${item.image}" alt="${item.productName}" style="width:64px;height:64px;object-fit:cover;border-radius:8px;" />` : ''}
              </td>
              <td>
                  ${item.productName}
                  ${item.size ? `<br/><span class="muted">Size: ${item.size}</span>` : ''}
                  ${item.color ? `<br/><span class="muted">Color: ${item.color}</span>` : ''}
                  <br/><span class="muted">${item.brand}</span>
              </td>
              <td>
                  $${item.price}
                  ${(function () {
              const product = typeof PRODUCTS !== 'undefined' ? PRODUCTS.find(p => p.id === item.productId) : null;
              if (product && product.mrp > item.price) {
                const diff = product.mrp - item.price;
                const pct = Math.round((diff / product.mrp) * 100);
                return `<br/><span style="color:green;font-size:0.85em;">${pct}% off</span>`;
              }
              return '';
            })()}
              </td>
              <td style="white-space:nowrap;">
                  <button class="button small secondary qty-btn" data-action="decrease" data-id="${item.productId}" data-size="${item.size || ''}" data-color="${item.color || ''}" style="padding:2px 8px;">-</button>
                  <span style="margin:0 8px;display:inline-block;width:20px;text-align:center;">${item.qty}</span>
                  <button class="button small secondary qty-btn" data-action="increase" data-id="${item.productId}" data-size="${item.size || ''}" data-color="${item.color || ''}" style="padding:2px 8px;">+</button>
              </td>
              <td>$${(item.price * item.qty).toFixed(2)}</td>
              <td>
                <button class="button secondary" data-action="remove-item" data-id="${item.productId}" data-size="${item.size || ''}" data-color="${item.color || ''}">Remove</button>
              </td>
            </tr>
          `;
        });
        html += '</tbody></table>';

        // Coupon and Totals Section (Enhanced)
        const availableCoupons = window.StaticData.getAvailableCoupons();

        html += `<div class="cart-footer" style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-top:24px;">
          <!-- Coupons Panel -->
          <div class="coupons-panel" style="background:#fff;border:1px solid #eee;border-radius:8px;padding:16px;">
            <h4 style="margin-top:0;">Available Coupons</h4>
            <div class="coupon-list" style="display:flex;flex-direction:column;gap:12px;max-height:300px;overflow-y:auto;">
              ${availableCoupons.map(c => {
          const isApplied = coupon && coupon.code === c.code;
          return `
                 <div class="coupon-card" style="border:1px solid ${isApplied ? 'green' : '#ddd'};padding:12px;border-radius:6px;background:${isApplied ? '#eaffea' : '#fff'};">
                    <div style="display:flex;justify-content:space-between;font-weight:bold;">
                        <span>${c.code}</span>
                        ${isApplied ? '<span style="color:green">APPLIED</span>' : ''}
                    </div>
                    <div style="font-size:0.9em;color:#666;margin:4px 0;">${c.description}</div>
                    ${!isApplied ?
              `<button class="button small secondary apply-coupon-btn" data-code="${c.code}" style="width:100%;margin-top:8px;">Apply</button>` :
              `<button class="button small remove-coupon-btn" style="width:100%;margin-top:8px;border-color:#c00;color:#c00;">Remove</button>`
            }
                 </div>
                 `;
        }).join('')}
            </div>
            <p id="coupon-message" style="color:#c00;font-size:0.9em;margin-top:12px;text-align:center;min-height:20px;"></p>
          </div>
          
          <!-- Totals Panel -->
          <div class="summary" style="background:#f9f9f9;padding:20px;border-radius:8px;text-align:right;">
            <h3 style="margin-top:0;">Order Summary</h3>
            <p><strong>Subtotal:</strong> $${subtotal.toFixed(2)}</p>
            ${coupon ? `<p style="color:green;"><strong>Discount (${coupon.code}):</strong> -$${(subtotal - total).toFixed(2)}</p>` : ''}
            <p style="font-size:1.4em;margin-top:12px;border-top:1px solid #ddd;padding-top:12px;"><strong>Total:</strong> $${total.toFixed(2)}</p>
            <a class="button primary full-width" id="checkout-button" href="./checkout.html" style="display:block;margin-top:16px;text-align:center;">Proceed to checkout</a>
          </div>
        </div>`;

        container.innerHTML = html;

        // Attach Coupon Listeners
        document.querySelectorAll('.apply-coupon-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const code = e.target.getAttribute('data-code');
            const result = window.StaticData.applyCoupon(code);
            if (result.success) {
              window.location.reload(); // Reload on change
            } else {
              document.getElementById('coupon-message').textContent = result.message;
            }
          });
        });

        document.querySelectorAll('.remove-coupon-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            window.StaticData.removeCoupon();
            window.location.reload(); // Reload on change
          });
        });


        // Attach checkout button event listener
        const checkoutButton = document.getElementById('checkout-button');
        if (checkoutButton) {
          checkoutButton.addEventListener('click', (e) => {
            e.preventDefault();
            const currentCart = window.StaticData.getCart();
            const currentTotal = window.StaticData.getCartTotal();
            const totalQuantity = currentCart.items.reduce((sum, item) => sum + item.qty, 0);

            if (window.adl && window.adl.trackBeginCheckout) {
              // Try to find phone if we are on checkout page? No, this is Cart page -> Checkout.
              // We likely don't have phone yet unless it's in storage.
              const storedPhone = sessionStorage.getItem("shopkart_phone");
              window.adl.trackBeginCheckout({
                totalQuantity: totalQuantity,
                totalValue: currentTotal
              }, { phone: storedPhone });
            }

            setTimeout(() => {
              window.location.href = './checkout.html';
            }, 100);
          });
        }
      }

      // Main Execution
      renderCart();

      // Event Delegation (Attached ONCE to cart-content)
      const cartContent = document.getElementById('cart-content');
      if (cartContent) {
        cartContent.addEventListener('click', (e) => {
          // Handle Remove
          const removeBtn = e.target.closest('[data-action="remove-item"]');
          if (removeBtn) {
            const productId = removeBtn.dataset.id;
            const size = removeBtn.dataset.size;
            const color = removeBtn.dataset.color;

            // Find item for tracking
            const cart = window.StaticData.getCart();
            const itemToRemove = cart.items.find(item =>
              item.productId === productId &&
              (item.size || '') === size &&
              (item.color || '') === color
            );

            // Track BEFORE remove to have data
            if (itemToRemove && window.adl && window.adl.trackRemoveFromCart) {
              const productDef = typeof PRODUCTS !== 'undefined' ? PRODUCTS.find(p => p.id === productId) : null;
              window.adl.trackRemoveFromCart({
                sku: productDef ? productDef.sku : (itemToRemove.sku || ''),
                productID: itemToRemove.productId,
                productName: itemToRemove.productName,
                brand: itemToRemove.brand,
                price: itemToRemove.price,
                quantity: itemToRemove.qty,
                size: size,
                color: color
              }, { pageName: 'cart', linkPosition: 'cart-table' });
            }

            // Perform Action
            window.StaticData.removeFromCart(productId, size, color);

            // RELOAD
            window.location.reload();
            return;
          }

          // Handle Qty
          const qtyBtn = e.target.closest('.qty-btn');
          if (qtyBtn) {
            const action = qtyBtn.dataset.action;
            const productId = qtyBtn.dataset.id;
            const size = qtyBtn.dataset.size;
            const color = qtyBtn.dataset.color;

            const cart = window.StaticData.getCart();
            const item = cart.items.find(item =>
              item.productId === productId &&
              (item.size || '') === size &&
              (item.color || '') === color
            );

            if (item) {
              let newQty = item.qty;
              if (action === 'increase') newQty++;
              if (action === 'decrease') newQty = Math.max(1, newQty - 1);

              if (newQty !== item.qty) {
                window.StaticData.updateItemQty(productId, size, color, newQty);
                // RELOAD
                window.location.reload();
              }
            }
          }
        });
      }

      // Update user info
      const user = window.StaticData ? window.StaticData.getUser() : null;
      const userInfo = document.getElementById('user-info');
      const accountLink = document.getElementById('account-link');
      const logoutLink = document.getElementById('logout-link');

      if (user) {
        if (userInfo) userInfo.textContent = user.name;
        if (accountLink) accountLink.style.display = 'none';
        if (logoutLink) logoutLink.style.display = 'inline';
      } else {
        if (userInfo) userInfo.textContent = '';
        if (accountLink) accountLink.style.display = 'inline';
        if (logoutLink) logoutLink.style.display = 'none';
      }
    })();
  </script>
  <script src="./public/footer-injector.js"></script>
</body>

</html>