<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product Listing | ShopKart</title>
  <link rel="stylesheet" href="./public/styles.css" />
  <script>window.adobeDataLayer = window.adobeDataLayer || [];</script>
  <script src="./public/products.js"></script>
  <script src="./public/static-data.js"></script>
  <script src="./public/adl-utils.js"></script>
  <script>
    (function () {
      const urlParams = new URLSearchParams(window.location.search);
      const category = (urlParams.get('cat') || '').toLowerCase();
      const searchQuery = (urlParams.get('q') || '').toLowerCase().trim();

      let filtered = PRODUCTS;

      if (category && category !== 'all') {
        filtered = filtered.filter((p) => p.category.toLowerCase() === category);
      }

      if (searchQuery) {
        filtered = filtered.filter((p) =>
          p.name.toLowerCase().includes(searchQuery) ||
          p.brand.toLowerCase().includes(searchQuery) ||
          p.category.toLowerCase().includes(searchQuery)
        );
      }

      // Store filtered products for rendering
      window.filteredProducts = filtered;
      window.selectedCategory = category || 'all';
      window.searchQuery = searchQuery;

      const catLabel = category && category !== 'all'
        ? category.charAt(0).toUpperCase() + category.slice(1)
        : 'All';

      const user = window.StaticData ? window.StaticData.getUser() : null;
      const url = window.location;

      // Calculate Products for Data Layer (Standardized Logic)
      const plpProducts = (window.filteredProducts || []).map(p => {
        const mrp = p.mrp || p.price;
        const discountAmount = mrp > p.price ? mrp - p.price : 0;
        const discountPercent = mrp > p.price ? Math.round((discountAmount / mrp) * 100) : 0;
        return {
          productID: p.id,
          sku: p.sku || '',
          productName: p.name,
          brand: p.brand || 'shopkart',
          category: p.category,
          price: p.price,
          originalPrice: mrp,
          discountAmount: discountAmount,
          discountPercentage: discountPercent,
          currencyCode: "USD",
          productImageUrl: p.image,
          productUrl: `${url.origin}${url.pathname.replace('plp.html', 'pdp.html')}?id=${p.id}`
        };
      });

      // 1. Page Load - Merged with Product List (One Event)
      window.adobeDataLayer.push({
        event: "pageLoaded",
        xdmPageLoad: {
          custData: {
            loginStatus: user ? "logged-in" : "guest",
            platform: "desktop web",
            language: "en"
          },
          web: {
            webPageDetails: {
              siteName: "shopkart",
              pageName: `Product Listing - ${catLabel}`,
              pageType: "category",
              channel: "web|plp"
            }
          },
          xdmCommerce: {
            productList: {
              category: (category && category !== 'all') ? catLabel : 'All Products',
              products: plpProducts
            }
          },
          pageUrl: {
            dataLayerUrl: url.href,
            deUrl: url.href,
            urlWithQSP: url.href,
            urlWithoutQSP: url.origin + url.pathname
          }
        }
      });
      console.log("ACDL: pageLoaded tracked (PLP) with " + plpProducts.length + " products");
    })();
  </script>
  <script src="https://assets.adobedtm.com/21b53c73144b/0bfb0f66930e/launch-c5c9b732c095-development.min.js"
    async></script>
</head>

<body data-page-type="plp">
  <header>
    <div class="topbar">
      <div class="logo"><a href="./index.html" style="color:#fff;text-decoration:none;">ShopKart</a></div>
      <form class="search" method="GET" action="./plp.html">
        <input type="text" name="q" placeholder="Search for electronics, fashion, home and more"
          aria-label="Search products" id="search-input" value="" />
        <button type="submit">Search</button>
      </form>
      <div class="actions">
        <span id="user-info"></span>
        <a href="./account.html" aria-label="Account" id="account-link">Account</a>
        <a href="./logout.html" aria-label="Logout" id="logout-link" style="display:none;">Logout</a>
        <a href="./cart.html" data-role="cart-link" aria-label="Cart">Cart <span class="cart-badge"
            data-role="cart-count">0</span></a>
      </div>
    </div>
    <div class="categories">
      <a href="./plp.html?cat=electronics">Electronics</a>
      <a href="./plp.html?cat=mobiles">Mobiles</a>
      <a href="./plp.html?cat=fashion">Fashion</a>
      <a href="./plp.html?cat=home%20appliances">Home Appliances</a>
      <a href="./plp.html?cat=beauty">Beauty</a>
      <a href="./plp.html?cat=all">All</a>
    </div>
  </header>
  <main>
    <div class="plp-background"
      style="background-image: url('https://images.unsplash.com/photo-1581091012184-5c4c11c3f024');"></div>
    <div class="plp-toolbar">
      <div class="muted" id="product-count">Showing 0 items</div>
      <div class="filters">
        <select id="category-select">
          <option>Category: all</option>
        </select>
        <select>
          <option>Sort: Most Popular</option>
          <option>Sort: Price Low → High</option>
        </select>
      </div>
    </div>
    <h2 id="category-title">All categories</h2>
    <p class="muted" id="category-description">Curated deals across ShopKart.</p>
    <div class="grid plp-grid" id="products-grid">
      <!-- Will be populated by JavaScript -->
    </div>
  </main>
  <footer>
    <p>ShopKart marketplace</p>
  </footer>
  <script src="./public/adl-utils.js"></script>
  <script src="./public/client.js"></script>
  <script>
    (function () {
      if (typeof window.filteredProducts === 'undefined') return;

      const products = window.filteredProducts;
      const selectedCategory = window.selectedCategory || 'all';
      const searchQuery = window.searchQuery || '';

      // Update UI
      document.getElementById('product-count').textContent = `Showing ${products.length} items`;
      document.getElementById('category-select').innerHTML = `<option>Category: ${selectedCategory}</option>`;

      const catLabel = selectedCategory && selectedCategory !== 'all'
        ? selectedCategory.charAt(0).toUpperCase() + selectedCategory.slice(1)
        : 'All categories';
      document.getElementById('category-title').textContent = catLabel;
      document.getElementById('category-description').textContent = `Curated deals across ${selectedCategory && selectedCategory !== 'all' ? selectedCategory : 'ShopKart'}.`;

      // Set search input value
      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        searchInput.value = searchQuery;
      }

      // Render products
      const grid = document.getElementById('products-grid');
      if (grid) {
        if (products.length === 0) {
          grid.innerHTML = '<p class="muted">No products found in this category. Try All.</p>';
        } else {
          grid.innerHTML = '';
          products.forEach((product, idx) => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
              <div class="card-image">
                <a href="./pdp.html?id=${product.id}" 
                   data-action="view-product"
                   data-product-id="${product.id}"
                   data-product-name="${product.name}"
                   data-product-category="${product.category}"
                   data-brand="${product.brand}"
                   data-price="${product.price}"
                   data-position="${product.position}"
                   data-href="./pdp.html?id=${product.id}"
                   style="display:block;width:100%;height:100%;">
                  <img src="${product.image}" alt="${product.name}" onerror="this.onerror=null; this.src=this.src.startsWith('http') ? './public/images/placeholders/missing-banner.png' : this.src;" />
                </a>
                ${product.badge ? `<div class="badge">${product.badge}</div>` : ''}
                <div class="brand-pill">${product.brand}</div>
              </div>
              <h3>${product.name}</h3>
              <p class="muted">${product.category}</p>
              <p class="price">$${product.price} <span class="muted" style="text-decoration:line-through;">$${product.mrp}</span></p>
              <div class="stars">★★★★☆</div>
              <a
                class="button secondary"
                href="./pdp.html?id=${product.id}"
                data-action="view-product"
                data-product-id="${product.id}"
                data-product-name="${product.name}"
                data-product-category="${product.category}"
                data-brand="${product.brand}"
                data-price="${product.price}"
                data-position="${product.position}"
                 data-href="./pdp.html?id=${product.id}"
              >
                View
              </a>
            `;
            grid.appendChild(card);
          });
        }
      }

      // Update user info
      const user = window.StaticData ? window.StaticData.getUser() : null;
      const userInfo = document.getElementById('user-info');
      const accountLink = document.getElementById('account-link');
      const logoutLink = document.getElementById('logout-link');

      if (user) {
        if (userInfo) userInfo.textContent = user.name;
        if (accountLink) accountLink.style.display = 'none';
        if (logoutLink) logoutLink.style.display = 'inline';
      } else {
        if (userInfo) userInfo.textContent = '';
        if (accountLink) accountLink.style.display = 'inline';
        if (logoutLink) logoutLink.style.display = 'none';
      }
    })();
  </script>
  <script src="./public/footer-injector.js"></script>
</body>

</html>